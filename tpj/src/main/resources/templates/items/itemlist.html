<!DOCTYPE html>
<html lang="en"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{/layout/defaultLayout}"
      layout:fragment="Content">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>등록한 물품 목록</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
  <script>
    let changes = {}; // 변경사항을 저장할 객체

    function increaseQuantity(button) {
        const itemId = button.getAttribute('data-item-id'); // 데이터 식별자 가져오기
        const quantityElement = document.getElementById(`quantity-${itemId}`); // 수량 표시 엘리먼트
        let currentQuantity = parseInt(quantityElement.textContent); // 현재 수량
        quantityElement.textContent = ++currentQuantity; // 수량 증가
        document.getElementById(`hiddenQuantity-${itemId}`).value = currentQuantity; // 숨겨진 input 업데이트
        changes[itemId] = currentQuantity; // 변경사항 저장
    }

    function decreaseQuantity(button) {
        const itemId = button.getAttribute('data-item-id'); // 데이터 식별자 가져오기
        const quantityElement = document.getElementById(`quantity-${itemId}`); // 수량 표시 엘리먼트
        let currentQuantity = parseInt(quantityElement.textContent); // 현재 수량
        if (currentQuantity > 1) {
            quantityElement.textContent = --currentQuantity; // 수량 감소
            document.getElementById(`hiddenQuantity-${itemId}`).value = currentQuantity; // 숨겨진 input 업데이트
            changes[itemId] = currentQuantity; // 변경사항 저장
        }
    }

    function applyChanges() {
        fetch('/items/update', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(changes) // 변경사항을 서버로 전송
        })
        .then(response => response.json())
        .then(result => {
            if (result.success) {
                alert('수정이 완료되었습니다.');
                location.reload(); // 페이지 새로고침
            } else {
                alert('수정 실패: ' + result.message);
            }
        })
        .catch(error => console.error('Error:', error));
    }
  </script>
</head>
<body>
<div class="container mt-5">
  <h1 class="mb-4">등록한 물품 목록</h1>
  <!-- 수정 적용을 위한 폼 -->
  <form action="/items/update" method="post">

  <!-- 물품 목록 테이블 -->
  <table class="table table-bordered text-center">
    <thead class="table-light">
    <tr>
      <th>PRODUCT</th>
      <th>CATEGORIES</th>
      <th>AMOUNT</th>
      <th>ACTION</th>
    </tr>
    </thead>
    <tbody>
    <tr th:each="item : ${groupedItems}">
      <td th:text="${item['itemName']}">물품명</td>
      <td th:text="${item['category']}">카테고리</td>
      <td>
        <div class="d-flex justify-content-center align-items-center">
          <!-- 감소 버튼 -->
          <button type="button"
                  class="btn btn-outline-secondary btn-sm me-2"
                  data-item-id="${item.itemId}"
                  onclick="decreaseQuantity(this)">-</button>
          <!-- 수량 표시 -->
          <span id="quantity-${item.itemId}" th:text="${item['count']}">0</span>
          <!-- 증가 버튼 -->
          <button type="button"
                  class="btn btn-outline-secondary btn-sm ms-2"
                  data-item-id="${item.itemId}"
                  onclick="increaseQuantity(this)">+</button>
          <!-- 숨겨진 input (수정 적용 시 사용) -->
          <input type="hidden" id="hiddenQuantity-${item.itemId}" th:value="${item['count']}">
        </div>
      </td>
      <td>
        <a th:href="@{/items/delete/{id}(id=${item['itemName']})}" class="btn btn-danger btn-sm">삭제</a>
      </td>
    </tr>
    </tbody>
  </table>

  <!-- 하단 버튼 -->
  <div class="d-flex justify-content-between">
    <a href="/" class="btn btn-secondary">뒤로가기</a>
    <div>
      <button type="submit" class="btn btn-success me-2">수정적용</button>
      <a href="/items/register" class="btn btn-primary">물품 등록</a>
    </div>
  </div>
  </form>
</div>
</body>
</html>